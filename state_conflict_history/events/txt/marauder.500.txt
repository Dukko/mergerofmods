namespace = marauder
@CmtConstKhanLifespan_1a = 1
@CmtConstKhanLifespan_1c = 35
@CmtConstKhanLifespan_1d = 5
@CmtConstKhanLifespan_2a = 4320
@CmtConstKhanLifespan_2c = 7200
@CmtConstKhanLifespan_2d = 2880
@CmtConstKhanLifespan_3a = 7200
@CmtConstKhanLifespan_3c = 10800
@CmtConstKhanLifespan_3d = 5000
@CmtConstKhanLifespan_4a = 10800
@CmtConstKhanLifespan_4c = 16200
@CmtConstKhanLifespan_4d = 5400
@CmtConstKhanLifespan_5a = 18000
@CmtConstKhanLifespan_5c = 27000
@CmtConstKhanLifespan_5d = 9000
country_event = {
    id = marauder.500
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        CmtTriggerHasPotentialKhanAwaking = yes
        NOT = {
            CmtTriggerNowInKhanCrisis = yes
        }
    }
    immediate = {
        set_global_flag = CmtFlagKhanTriggered
        set_global_flag = marauder_crisis_started
        set_global_flag = marauder_crisis_ongoing
        if = {
            limit = {
                exists = event_target:raider_khanate
            }
            clear_global_event_target = raider_khanate
        }
        save_global_event_target_as = raider_khanate
        random_country = {
            limit = {
                has_country_flag = marauder_1
            }
            owner_species = {
                save_global_event_target_as = CmtTargetSpecies_Marauder1
            }
            if = {
                limit = {
                    any_system_within_border = {
                        has_star_flag = marauder_capital_1
                    }
                }
                random_system_within_border = {
                    limit = {
                        has_star_flag = marauder_capital_1
                    }
                    if = {
                        limit = {
                            any_system_planet = {
                                has_planet_flag = raid_source
                            }
                        }
                        random_system_planet = {
                            limit = {
                                has_planet_flag = raid_source
                            }
                            save_global_event_target_as = CmtTargetMarauderRallyPoint1
                        }
                    }
                    else = {
                        random_system_planet = {
                            limit = {
                                is_star = no
                            }
                            save_global_event_target_as = CmtTargetMarauderRallyPoint1
                        }
                        log = "Backup Code for CmtTargetMarauderRallyPoint1 - 1 Processed"
                    }
                }
            }
            else = {
                random_planet_within_border = {
                    limit = {
                        is_star = no
                    }
                    save_global_event_target_as = CmtTargetMarauderRallyPoint1
                }
                log = "Backup Code for CmtTargetMarauderRallyPoint1 - 2 Processed"
            }
        }
        random_country = {
            limit = {
                has_country_flag = marauder_2
            }
            owner_species = {
                save_global_event_target_as = CmtTargetSpecies_Marauder2
            }
            if = {
                limit = {
                    any_system_within_border = {
                        has_star_flag = marauder_capital_2
                    }
                }
                random_system_within_border = {
                    limit = {
                        has_star_flag = marauder_capital_2
                    }
                    if = {
                        limit = {
                            any_system_planet = {
                                has_planet_flag = raid_source
                            }
                        }
                        random_system_planet = {
                            limit = {
                                has_planet_flag = raid_source
                            }
                            save_global_event_target_as = CmtTargetMarauderRallyPoint2
                        }
                    }
                    else = {
                        random_system_planet = {
                            limit = {
                                is_star = no
                            }
                            save_global_event_target_as = CmtTargetMarauderRallyPoint2
                        }
                        log = "Backup Code for CmtTargetMarauderRallyPoint2 - 1 Processed"
                    }
                }
            }
            else = {
                random_planet_within_border = {
                    limit = {
                        is_star = no
                    }
                    save_global_event_target_as = CmtTargetMarauderRallyPoint2
                }
                log = "Backup Code for CmtTargetMarauderRallyPoint2 - 2 Processed"
            }
        }
        random_country = {
            limit = {
                has_country_flag = marauder_3
            }
            owner_species = {
                save_global_event_target_as = CmtTargetSpecies_Marauder3
            }
            if = {
                limit = {
                    any_system_within_border = {
                        has_star_flag = marauder_capital_3
                    }
                }
                random_system_within_border = {
                    limit = {
                        has_star_flag = marauder_capital_3
                    }
                    if = {
                        limit = {
                            any_system_planet = {
                                has_planet_flag = raid_source
                            }
                        }
                        random_system_planet = {
                            limit = {
                                has_planet_flag = raid_source
                            }
                            save_global_event_target_as = CmtTargetMarauderRallyPoint3
                        }
                    }
                    else = {
                        random_system_planet = {
                            limit = {
                                is_star = no
                            }
                            save_global_event_target_as = CmtTargetMarauderRallyPoint3
                        }
                        log = "Backup Code for CmtTargetMarauderRallyPoint3 - 1 Processed"
                    }
                }
            }
            else = {
                random_planet_within_border = {
                    limit = {
                        is_star = no
                    }
                    save_global_event_target_as = CmtTargetMarauderRallyPoint3
                }
                log = "Backup Code for CmtTargetMarauderRallyPoint3 - 2 Processed"
            }
        }
        if = {
            limit = {
                exists = event_target:CmtTargetMarauderRallyPoint1
            }
            event_target:CmtTargetMarauderRallyPoint1 = {
                set_planet_flag = CmtFlagMarauderExpRallyPoint
                if = {
                    limit = {
                        exists = solar_system.owner
                        solar_system.owner = {
                            is_same_empire = root
                        }
                    }
                    save_global_event_target_as = marauder_rally_point
                    set_planet_flag = marauder_rally_point
                }
            }
        }
        if = {
            limit = {
                exists = event_target:CmtTargetMarauderRallyPoint2
            }
            event_target:CmtTargetMarauderRallyPoint2 = {
                set_planet_flag = CmtFlagMarauderExpRallyPoint
                if = {
                    limit = {
                        exists = solar_system.owner
                        solar_system.owner = {
                            is_same_empire = root
                        }
                    }
                    save_global_event_target_as = marauder_rally_point
                    set_planet_flag = marauder_rally_point
                }
            }
        }
        if = {
            limit = {
                exists = event_target:CmtTargetMarauderRallyPoint3
            }
            event_target:CmtTargetMarauderRallyPoint3 = {
                set_planet_flag = CmtFlagMarauderExpRallyPoint
                if = {
                    limit = {
                        exists = solar_system.owner
                        solar_system.owner = {
                            is_same_empire = root
                        }
                    }
                    save_global_event_target_as = marauder_rally_point
                    set_planet_flag = marauder_rally_point
                }
            }
        }
        if = {
            limit = {
                event_target:CmtGlobalVar = {
                    check_variable = {
                        which = CmtVarKhanMultiple
                        value = 5
                    }
                }
            }
            every_country = {
                limit = {
                    is_country_type = dormant_marauders
                    NOT = {
                        is_same_value = root
                    }
                }
                every_owned_fleet = {
                    set_owner = root
                }
                destroy_country = yes
            }
        }
        if = {
            limit = {
                NOT = {
                    exists = event_target:marauder_rally_point
                }
            }
            random_planet_within_border = {
                limit = {
                    is_star = no
                }
                save_global_event_target_as = marauder_rally_point
                set_planet_flag = marauder_rally_point
                log = "Backup Code for marauder_rally_point Processed"
            }
        }
        set_country_type = awakened_marauders
        set_name = random
        change_country_flag = {
            icon = {
                category = "pirate"
                file = "flag_pirate_11.dds"
            }
            background = {
                category = "backgrounds"
                file = "00_solid.dds"
            }
            colors = {
                "red"
                "red"
                "null"
                "null"
            }
        }
        change_government = {
            civics = {
                civic = civic_great_khans_vision
            }
        }
        create_ship_design = {
            design = "NAME_Pirate_Transport"
        }
        add_ship_design = last_created_design
        create_ship_design = {
            design = "NAME_Clan_Builder"
        }
        add_ship_design = last_created_design
        create_leader = {
            class = ruler
            species = owner_main_species
            name = random
            skill = 10
            leader_age_min = 22
            leader_age_max = 40
            traits = {
                trait = leader_trait_ruler_great_khan
            }
        }
        last_created_leader = {
            set_leader_flag = great_khan
            save_global_event_target_as = great_khan_ruler
        }
        assign_leader = last_created_leader
        if = {
            limit = {
                event_target:CmtGlobalVar = {
                    check_variable = {
                        which = CmtVarKhanLifespan
                        value = 1
                    }
                }
            }
            set_timed_global_flag = {
                flag = khan_no_die
                days = @CmtConstKhanLifespan_1a
            }
            set_timed_country_flag = {
                flag = CmtFlagKhanNoDieCountry
                days = @CmtConstKhanLifespan_1a
            }
            country_event = {
                id = marauder.514
                days = @CmtConstKhanLifespan_1c
                random = @CmtConstKhanLifespan_1d
            }
        }
        else_if = {
            limit = {
                event_target:CmtGlobalVar = {
                    check_variable = {
                        which = CmtVarKhanLifespan
                        value = 2
                    }
                }
            }
            set_timed_global_flag = {
                flag = khan_no_die
                days = @CmtConstKhanLifespan_2a
            }
            set_timed_country_flag = {
                flag = CmtFlagKhanNoDieCountry
                days = @CmtConstKhanLifespan_2a
            }
            country_event = {
                id = marauder.514
                days = @CmtConstKhanLifespan_2c
                random = @CmtConstKhanLifespan_2d
            }
        }
        else_if = {
            limit = {
                event_target:CmtGlobalVar = {
                    check_variable = {
                        which = CmtVarKhanLifespan
                        value = 4
                    }
                }
            }
            set_timed_global_flag = {
                flag = khan_no_die
                days = @CmtConstKhanLifespan_4a
            }
            set_timed_country_flag = {
                flag = CmtFlagKhanNoDieCountry
                days = @CmtConstKhanLifespan_4a
            }
            country_event = {
                id = marauder.514
                days = @CmtConstKhanLifespan_4c
                random = @CmtConstKhanLifespan_4d
            }
        }
        else_if = {
            limit = {
                event_target:CmtGlobalVar = {
                    check_variable = {
                        which = CmtVarKhanLifespan
                        value = 5
                    }
                }
            }
            set_timed_global_flag = {
                flag = khan_no_die
                days = @CmtConstKhanLifespan_5a
            }
            set_timed_country_flag = {
                flag = CmtFlagKhanNoDieCountry
                days = @CmtConstKhanLifespan_5a
            }
            country_event = {
                id = marauder.514
                days = @CmtConstKhanLifespan_5c
                random = @CmtConstKhanLifespan_5d
            }
        }
        else_if = {
            limit = {
                event_target:CmtGlobalVar = {
                    check_variable = {
                        which = CmtVarKhanLifespan
                        value = 6
                    }
                }
            }
            set_global_flag = khan_no_die
            set_country_flag = CmtFlagKhanNoDieCountry
        }
        else = {
            set_timed_global_flag = {
                flag = khan_no_die
                days = @CmtConstKhanLifespan_3a
            }
            set_timed_country_flag = {
                flag = CmtFlagKhanNoDieCountry
                days = @CmtConstKhanLifespan_3a
            }
            country_event = {
                id = marauder.514
                days = @CmtConstKhanLifespan_3c
                random = @CmtConstKhanLifespan_3d
            }
        }
        CmtEffectTransferKhanRemainingLive = yes
        clone_leader = {
            target = event_target:great_khan_ruler
            class = admiral
            skill = 10
            traits = {
                trait = leader_trait_great_khan
            }
            effect = {
                set_leader_flag = great_khan
                save_global_event_target_as = great_khan
            }
        }
        event_target:marauder_rally_point = {
            CmtEffectCreateAdmiralty_Khan1stFleet = yes
        }
        if = {
            limit = {
                event_target:CmtGlobalVar = {
                    check_variable = {
                        which = CmtVarKhanMultiple
                        value = 5
                    }
                }
            }
            every_planet_within_border = {
                limit = {
                    has_planet_flag = CmtFlagMarauderExpRallyPoint
                }
                CmtEffectCreateAdmiralty_KhanStarterPack = yes
            }
        }
        else = {
            event_target:marauder_rally_point = {
                CmtEffectCreateAdmiralty_KhanStarterPack = yes
            }
        }
        country_event = {
            id = marauder.78
            days = 20
        }
        country_event = {
            id = marauder.520
            days = 180
        }
        event_target:CmtGlobalVar = {
            set_variable = {
                which = CmtVarKhanReinforcementCounter
                value = 10
            }
        }
        every_country = {
            limit = {
                is_country_type = enclave
            }
            event_target:raider_khanate = {
                set_faction_hostility = {
                    target = prev
                    set_hostile = no
                    set_neutral = no
                    set_friendly = yes
                }
            }
        }
        if = {
            limit = {
                has_country_flag = CmtFlagKhanVengeanceCountry
            }
            every_country = {
                limit = {
                    is_ai = no
                }
                establish_communications_no_message = root
                country_event = {
                    id = marauder.526
                }
                observer_event = {
                    id = observer.18
                }
            }
        }
        else = {
            every_country = {
                limit = {
                    is_ai = no
                }
                establish_communications_no_message = root
                country_event = {
                    id = marauder.501
                }
                observer_event = {
                    id = observer.13
                }
            }
        }
        every_country = {
            limit = {
                is_ai = yes
                is_country_type = default
            }
            establish_communications_no_message = root
        }
        if = {
            limit = {
                OR = {
                    has_country_flag = marauder_1
                    AND = {
                        exists = event_target:CmtTargetMarauderRallyPoint1.solar_system.owner
                        event_target:CmtTargetMarauderRallyPoint1.solar_system.owner = {
                            is_same_empire = root
                        }
                    }
                }
            }
            every_country = {
                limit = {
                    CmtTriggerCountryHiringMarauder1 = yes
                }
                set_country_flag = CmtFlagHiringMarauder1
            }
        }
        if = {
            limit = {
                OR = {
                    has_country_flag = marauder_2
                    AND = {
                        exists = event_target:CmtTargetMarauderRallyPoint2.solar_system.owner
                        event_target:CmtTargetMarauderRallyPoint2.solar_system.owner = {
                            is_same_empire = root
                        }
                    }
                }
            }
            every_country = {
                limit = {
                    CmtTriggerCountryHiringMarauder2 = yes
                }
                set_country_flag = CmtFlagHiringMarauder2
            }
        }
        if = {
            limit = {
                OR = {
                    has_country_flag = marauder_3
                    AND = {
                        exists = event_target:CmtTargetMarauderRallyPoint3.solar_system.owner
                        event_target:CmtTargetMarauderRallyPoint3.solar_system.owner = {
                            is_same_empire = root
                        }
                    }
                }
            }
            every_country = {
                limit = {
                    CmtTriggerCountryHiringMarauder3 = yes
                }
                set_country_flag = CmtFlagHiringMarauder3
            }
        }
        every_country = {
            limit = {
                OR = {
                    has_country_flag = CmtFlagHiringMarauder1
                    has_country_flag = CmtFlagHiringMarauder2
                    has_country_flag = CmtFlagHiringMarauder3
                }
            }
            country_event = {
                id = marauder.77
                days = 20
            }
        }
    }
}